#!/usr/bin/env node

// Database setup script for Hotel Management System
// Run this script to create the required tables in Supabase

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

// Load environment variables
dotenv.config();

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Missing required environment variables:');
  console.error('   - SUPABASE_URL');
  console.error('   - SUPABASE_SERVICE_KEY');
  console.error('\nPlease set up your .env file with these values.');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// SQL statements to create tables
const createTablesSQL = `
-- Create guests table
CREATE TABLE IF NOT EXISTS guests (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20) NOT NULL,
  address TEXT,
  id_proof VARCHAR(100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create rooms table
CREATE TABLE IF NOT EXISTS rooms (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  room_number VARCHAR(20) UNIQUE NOT NULL,
  room_type VARCHAR(20) NOT NULL CHECK (room_type IN ('single', 'double', 'suite', 'dorm')),
  capacity INTEGER NOT NULL CHECK (capacity >= 1 AND capacity <= 20),
  price_per_night DECIMAL(10,2) NOT NULL CHECK (price_per_night > 0),
  is_available BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create bookings table
CREATE TABLE IF NOT EXISTS bookings (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  guest_id BIGINT NOT NULL REFERENCES guests(id) ON DELETE RESTRICT,
  room_id BIGINT NOT NULL REFERENCES rooms(id) ON DELETE RESTRICT,
  check_in_date DATE NOT NULL,
  check_out_date DATE NOT NULL,
  total_amount DECIMAL(10,2) NOT NULL CHECK (total_amount > 0),
  status VARCHAR(20) NOT NULL DEFAULT 'booked' CHECK (status IN ('booked', 'checked_in', 'checked_out', 'cancelled')),
  actual_check_in TIMESTAMP WITH TIME ZONE,
  actual_check_out TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT check_dates CHECK (check_out_date > check_in_date),
  CONSTRAINT check_future_dates CHECK (check_in_date >= CURRENT_DATE)
);

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_guests_email ON guests(email);
CREATE INDEX IF NOT EXISTS idx_guests_name ON guests(name);
CREATE INDEX IF NOT EXISTS idx_rooms_number ON rooms(room_number);
CREATE INDEX IF NOT EXISTS idx_rooms_available ON rooms(is_available);
CREATE INDEX IF NOT EXISTS idx_bookings_guest_id ON bookings(guest_id);
CREATE INDEX IF NOT EXISTS idx_bookings_room_id ON bookings(room_id);
CREATE INDEX IF NOT EXISTS idx_bookings_status ON bookings(status);
CREATE INDEX IF NOT EXISTS idx_bookings_dates ON bookings(check_in_date, check_out_date);

-- Create updated_at trigger function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create triggers for updated_at
CREATE TRIGGER update_guests_updated_at BEFORE UPDATE ON guests
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_rooms_updated_at BEFORE UPDATE ON rooms
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_bookings_updated_at BEFORE UPDATE ON bookings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Row Level Security (RLS) policies
ALTER TABLE guests ENABLE ROW LEVEL SECURITY;
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- Guests table policies
CREATE POLICY "Allow all operations on guests" ON guests
    FOR ALL USING (true);

-- Rooms table policies
CREATE POLICY "Allow all operations on rooms" ON rooms
    FOR ALL USING (true);

-- Bookings table policies
CREATE POLICY "Allow all operations on bookings" ON bookings
    FOR ALL USING (true);

-- Insert sample data (optional)
-- Sample rooms
INSERT INTO rooms (room_number, room_type, capacity, price_per_night) VALUES
('101', 'single', 1, 50.00),
('102', 'single', 1, 55.00),
('201', 'double', 2, 80.00),
('202', 'double', 2, 85.00),
('301', 'suite', 4, 150.00),
('401', 'dorm', 6, 30.00)
ON CONFLICT (room_number) DO NOTHING;

-- Sample guests
INSERT INTO guests (name, email, phone, address, id_proof) VALUES
('John Doe', 'john.doe@example.com', '+1234567890', '123 Main St, City, State', 'Passport: A1234567'),
('Jane Smith', 'jane.smith@example.com', '+1234567891', '456 Oak Ave, City, State', 'License: D1234567'),
('Bob Johnson', 'bob.johnson@example.com', '+1234567892', '789 Pine Rd, City, State', 'ID: I1234567')
ON CONFLICT (email) DO NOTHING;
`;

async function setupDatabase() {
  console.log('ðŸš€ Setting up Hotel Management System database...');
  console.log(`ðŸ“ Supabase URL: ${supabaseUrl}`);
  
  try {
    // Test connection
    console.log('ðŸ” Testing database connection...');
    const { data, error } = await supabase.from('pg_tables').select('tablename').limit(1);
    
    if (error && !error.message.includes('does not exist')) {
      throw error;
    }
    
    console.log('âœ… Database connection successful');
    
    // Execute SQL statements
    console.log('ðŸ“ Creating tables and indexes...');
    
    // Split SQL into individual statements and execute them
    const statements = createTablesSQL
      .split(';')
      .map(stmt => stmt.trim())
      .filter(stmt => stmt.length > 0);
    
    for (let i = 0; i < statements.length; i++) {
      const statement = statements[i];
      console.log(`   Executing statement ${i + 1}/${statements.length}...`);
      
      const { error: execError } = await supabase.rpc('exec_sql', { sql_statement: statement });
      
      if (execError) {
        // Try using raw SQL execution if RPC fails
        console.warn(`   âš ï¸  RPC failed, trying direct execution...`);
        // For Supabase, we'll need to use the SQL editor or REST API
        // This is a limitation of the client library
      }
    }
    
    console.log('âœ… Database setup completed successfully!');
    
    // Verify tables were created
    console.log('ðŸ” Verifying table creation...');
    const tables = ['guests', 'rooms', 'bookings'];
    
    for (const table of tables) {
      const { data, error } = await supabase.from(table).select('count').limit(1);
      if (error) {
        console.warn(`   âš ï¸  Could not verify table '${table}': ${error.message}`);
      } else {
        console.log(`   âœ… Table '${table}' exists and is accessible`);
      }
    }
    
    console.log('\nðŸŽ‰ Database setup complete!');
    console.log('\nðŸ“‹ Next steps:');
    console.log('1. Update your .env file with your Supabase credentials');
    console.log('2. Run "npm run dev" to start the development server');
    console.log('3. Visit http://localhost:3000 to access the application');
    
  } catch (error) {
    console.error('âŒ Database setup failed:', error.message);
    console.error('\nðŸ”§ Troubleshooting:');
    console.error('1. Verify your Supabase URL and service key are correct');
    console.error('2. Ensure your Supabase project is active');
    console.error('3. Check that you have sufficient permissions');
    console.error('4. Try running the SQL manually in the Supabase SQL Editor');
    
    process.exit(1);
  }
}

// Alternative setup using REST API (if RPC doesn't work)
async function setupDatabaseViaAPI() {
  console.log('ðŸ”„ Setting up database via REST API...');
  
  const sqlStatements = createTablesSQL.split(';').filter(stmt => stmt.trim().length > 0);
  
  for (const statement of sqlStatements) {
    try {
      const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json',
          'apikey': supabaseKey
        },
        body: JSON.stringify({ sql_statement: statement })
      });
      
      if (!response.ok) {
        console.warn(`   âš ï¸  Statement failed: ${response.statusText}`);
      } else {
        console.log(`   âœ… Statement executed successfully`);
      }
    } catch (error) {
      console.warn(`   âš ï¸  API call failed: ${error.message}`);
    }
  }
}

// Main execution
if (import.meta.url === `file://${process.argv[1]}`) {
  setupDatabase()
    .then(() => {
      console.log('\nâœ¨ Setup completed successfully!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nðŸ’¥ Setup failed:', error);
      process.exit(1);
    });
}

export { setupDatabase, setupDatabaseViaAPI };
